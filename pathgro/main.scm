;;
;; pathgro - combinatoric pathname wordlist expander
;;
;; v1.0 coded by Derek Callaway [derek.callaway (AT) iocative {D0T} com]
;;

(define-module (pathgro main)
               #:export (main cfiles cdirs)
               #:use-module (ice-9 and-let-star)
               #:use-module (ice-9 common-list)
               #:use-module (ice-9 getopt-long)
               #:use-module (srfi srfi-1))

(use-modules ((pathgro base read-pathsfiles) #:select (read-pathsfiles bases dirns extns)))
(use-modules ((pathgro base pathgro-full) #:select (pathgro-full combine-paths)))
(use-modules ((pathgro base prepend-slashes) #:select (prepend-slashes unprepend-slashes)))
(use-modules ((pathgro util ansi-color)))
(use-modules ((pathgro util flatten)))
(use-modules ((pathgro util println)))
(use-modules ((pathgro util unblank)))
(use-modules ((pathgro syntax let-values)))

(define-values (stdin stdout stderr) (values (current-input-port) (current-output-port) (current-error-port)))

(define pathgro-debug-mode #t)

(define (display-help)
  (newline)
  (display (colorize-string "usage" 'BLACK 'ON-YELLOW 'BOLD 'UNDERLINE))
  (display (colorize-string ": " 'BOLD))
  (display (colorize-string "pathgro" 'BLACK 'ON-GREEN 'BOLD))
  (display " ")
  (display (colorize-string "[<OPTIONS>]" 'BLACK 'ON-BLUE 'UNDERLINE))
  (display " ")
  (display (colorize-string "[<FILES>]" 'BLACK 'ON-BLUE 'UNDERLINE))
  (newline)(newline)
  (display "  ")
  (display (colorize-string "<OPTIONS>" 'BLACK 'ON-BLUE 'UNDERLINE))
  (display "         ")
  (display (colorize-string "one or more of the command line flags below" 'BLUE))
  (newline)(newline)
  (display "  ")
  (display (colorize-string "-v, --version" 'BLACK 'ON-CYAN 'BOLD))
  (display "     ")
  (display (colorize-string "displays the current software version banner string" 'CYAN))
  (newline)
  (display "  ")
  (display (colorize-string "-h, --help" 'BLACK 'ON-CYAN 'BOLD 'UNDERLINE))
  (display "        ")
  (display (colorize-string "shows the usage information you're reading now" 'CYAN))
  (newline)
  (display "  ")
  (display (colorize-string "-b, --basename" 'BLACK 'ON-GREEN 'BOLD))
  (display "    ")
  (display (colorize-string "display base file names" 'GREEN))
  (newline)
  (display "  ")
  (display (colorize-string "-d, --dirname" 'BLACK 'ON-GREEN 'BOLD))
  (display "     ")
  (display (colorize-string "display directory names" 'GREEN))
  (newline)
  (display "  ")
  (display (colorize-string "-e, --extname" 'BLACK 'ON-GREEN 'BOLD))
  (display "     ")
  (display (colorize-string "display file extensions" 'GREEN))
  (newline)
  (display "  ")
  (display (colorize-string "-x, --extdirname" 'BLACK 'ON-GREEN 'BOLD))
  (display "  ")
  (display (colorize-string "append file extensions to directory names" 'GREEN))
  (newline)
  (display "  ")
  (display (colorize-string "-p, --powerset" 'BLACK 'ON-GREEN 'BOLD))
  (display "    ")
  (display (colorize-string "compute all permutations and combinations of full pathnames" 'GREEN))
  (newline)
  (display "  ")
  (display (colorize-string "-s, --slash" 'BLACK 'ON-GREEN 'BOLD))
  (display "       ")
  (display (colorize-string "prepend each path name with a slash character" 'GREEN))
  (newline)
  (display "  ")
  (display (colorize-string "-n, --noslash" 'BLACK 'ON-GREEN 'BOLD))
  (display "     ")
  (display (colorize-string "remove the slash character from each path name" 'GREEN))
  (newline)
  (newline)
  (display "  ")
  (display (colorize-string "<FILES>" 'BLACK 'ON-BLUE 'UNDERLINE))
  (display "           ")
  (display (colorize-string "path names to wordlist files for parsing and expansion" 'BLUE))
  (newline)
  (newline)
  (exit 0))

(define (display-version)
  (newline)
  (display (colorize-string "pathgro" 'BLACK 'ON-GREEN 'BOLD))
  (display " ")
  (display (colorize-string "v1.0" 'BLACK 'ON-YELLOW 'UNDERLINE))
  (display " ")
  (display (colorize-string "by" 'BLACK 'ON-CYAN))
  (display " ")
  (display (colorize-string "Derek" 'BLACK 'ON-BLUE)) 
  (display " ")
  (display (colorize-string "Callaway" 'BLACK 'ON-BLUE))
  (display " ")
  (display (colorize-string "[" 'YELLOW 'BOLD))
  (display (colorize-string "derek" 'WHITE 'ON-BLUE 'REVERSE 'UNDERLINE))
  (display (colorize-string "." 'BLACK 'ON-MAGENTA 'REVERSE 'UNDERLINE)) 
  (display (colorize-string "callaway" 'WHITE 'ON-BLUE 'REVERSE 'UNDERLINE))
  (display " ")
  (display (colorize-string "(" 'BLACK 'ON-WHITE)) 
  (display (colorize-string "AT" 'WHITE 'ON-BLACK)) 
  (display (colorize-string ")" 'BLACK 'ON-WHITE))
  (display " ")
  (display (colorize-string "ioactive" 'WHITE 'ON-RED 'BOLD 'REVERSE 'UNDERLINE))
  (display " ")
  (display (colorize-string "{" 'BLACK 'ON-WHITE)) 
  (display (colorize-string "D0T" 'WHITE 'ON-BLACK))
  (display (colorize-string "}" 'BLACK 'ON-WHITE))
  (display " ")
  (display (colorize-string "com" 'WHITE 'ON-RED 'BOLD 'REVERSE 'UNDERLINE))
  (display (colorize-string "]" 'YELLOW 'BOLD))
  (newline)
  (newline)
  (exit 0))

(define (main args)
  (let* ((option-spec '((help    (single-char #\h))
                        (basename (single-char #\b))
                        (dirname (single-char #\d))
                        (extname (single-char #\e))
                        (filename (single-char #\f))
                        (powerset (single-char #\p))
                        (extdirname (single-char #\x))
                        (slash (single-char #\s))
                        (noslash (single-char #\n))
                        ;(rmtrail (single-char #\r)) ; remove trailing slash
                        (version (single-char #\v))))
                  (options        (getopt-long args option-spec #:stop-at-first-non-option #t))
                  (help-wanted    (option-ref options 'help #f))
                  (opt-basename   (option-ref options 'basename #f))
                  (opt-dirname    (option-ref options 'dirname #f))
                  (opt-extname    (option-ref options 'extname #f))
                  (opt-filename   (option-ref options 'filename #f))
                  (opt-extname    (option-ref options 'extname #f))
                  (opt-powerset   (option-ref options 'powerset #f))
                  (opt-extdirname (option-ref options 'extdirname #f))
                  (opt-slash      (option-ref options 'slash #f))
                  (opt-noslash    (option-ref options 'noslash #f))
                  ;(opt-rmtrail    (option-ref options 'rmtrail #f))
                  (version-wanted (option-ref options 'version #f)))
    (cond
      (help-wanted
        (display-help))
      (version-wanted
        (display-version))
      (else
        (let ((stripped-args (option-ref options '() '())))
          (read-pathsfiles stripped-args)
          (let ((edirs (flatten (uniq (unblank (combine-paths dirns extns)))))
                (efiles (flatten (uniq (unblank (combine-paths bases extns))))))
            (let-values ((cfiles cdirs) (values (uniq (unblank (combine-paths bases extns))) (uniq (unblank (append dirns edirs)))))
                ;(append (flatten cfiles) bases extns dirns edirs cdirs))
                (if (not (or opt-basename opt-dirname opt-extname opt-filename opt-extname opt-powerset opt-extdirname))
                  (display-help)
                  (begin
                    (when opt-noslash (when (not opt-slash) (set! prepend-slashes unprepend-slashes)))
                    (when opt-filename (for-each println (prepend-slashes efiles)))
                    (when opt-basename (for-each println (prepend-slashes bases)))
                    (when opt-extname  (for-each println (prepend-slashes extns)))
                    (when opt-extdirname (for-each println (prepend-slashes efiles)))
                    (when opt-powerset (for-each println (pathgro-full cfiles)))))
                (exit 0))))))))
