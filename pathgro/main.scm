;;
;; pathgro - combinatoric pathname wordlist expander
;;
;; v1.0 coded by Derek Callaway [derek.callaway (AT) ioactive {D0T} com]
;;

(define-module (pathgro main)
               #:export (main)
               #:use-module (ice-9 common-list)
               #:use-module (ice-9 getopt-long)
               #:use-module (srfi srfi-1))

(use-modules ((pathgro base read-pathsfiles)))
(use-modules ((pathgro base path-powerset)))
(use-modules ((pathgro base path-slashes)))
(use-modules ((pathgro util ansi-color)))
(use-modules ((pathgro util clean-list)))
(use-modules ((pathgro util splitter) #:select (max-depth)))
(use-modules ((pathgro util stdio)))

(define (display-help)
  (newline)
  (display (colorize-string "usage" 'YELLOW 'ON-BLUE 'BOLD 'UNDERLINE))
  (display (colorize-string ": " 'BOLD))
  (display (colorize-string "pathgro" 'WHITE 'ON-GREEN 'BOLD))
  (display " ")
  (display (colorize-string "[<OPTIONS>]" 'BLACK 'ON-GREEN 'BOLD 'UNDERLINE))
  (display " ")
  (display (colorize-string "[<FILES>]" 'BLACK 'ON-GREEN 'BOLD 'UNDERLINE))
  (newlines 2)
  (display "  ")
  (display (colorize-string "<OPTIONS>" 'BLACK 'ON-GREEN 'UNDERLINE))
  (display "            ")
  (display (colorize-string "one or more of the command line flags below" 'YELLOW))
  (newlines 2)
  (display "  ")
  (display (colorize-string "-v, --version" 'BLACK 'ON-YELLOW 'BOLD 'UNDERLINE))
  (display "        ")
  (display (colorize-string "displays the current software version banner string" 'CYAN))
  (newline)
  (display "  ")
  (display (colorize-string "-h, --help" 'BLACK 'ON-YELLOW  'BOLD 'UNDERLINE))
  (display "           ")
  (display (colorize-string "prints the usage information you're reading now" 'CYAN))
  (newline)
  (display "  ")
  (display (colorize-string "-b, --basename" 'BLACK 'ON-GREEN 'BOLD 'UNDERLINE))
  (display "       ")
  (display (colorize-string "show base file names" 'MAGENTA))
  (newline)
  (display "  ")
  (display (colorize-string "-d, --dirname" 'BLACK 'ON-GREEN 'BOLD 'UNDERLINE))
  (display "        ")
  (display (colorize-string "display directory names" 'MAGENTA))
  (newline)
  (display "  ")
  (display (colorize-string "-e, --extname" 'BLACK 'ON-GREEN 'BOLD 'UNDERLINE))
  (display "        ")
  (display (colorize-string "output file extensions" 'MAGENTA))
  (newline)
  (display "  ")
  (display (colorize-string "-f, --filename" 'BLACK 'ON-GREEN 'BOLD 'UNDERLINE))
  (display "       ")
  (display (colorize-string "print full filenames, i.e. \"basename.extname\"" 'MAGENTA))
  (newline)
  (display "  ")
  (display (colorize-string "-x, --extdirname" 'BLACK 'ON-GREEN 'BOLD 'UNDERLINE))
  (display "     ")
  (display (colorize-string "append file extensions to directory names" 'MAGENTA))
  (newline)
  (display "  ")
  (display (colorize-string "-n, --noslash" 'BLACK 'ON-GREEN 'BOLD 'UNDERLINE))
  (display "        ")
  (display (colorize-string "remove a forward slash from the start of each path name" 'MAGENTA))
  (newline)
  (display "  ")
  (display (colorize-string "-l, --level" 'BLACK 'ON-GREEN 'BOLD 'UNDERLINE))
  (display "  ")
  (display (colorize-string "DEPTH" 'BLACK 'ON-YELLOW 'REVERSE 'UNDERLINE))
  (display "   ")
  (display (colorize-string "compute all power set of pathnames up to specified directory depth" 'MAGENTA))
  (display "  ")
  ;(newline)
  ;(display "  ")
  ;(display (colorize-string "-i, --infix" 'BLACK 'ON-GREEN 'BOLD 'UNDERLINE))
  ;(display "  ")
  ;(display (colorize-string "STRING" 'BLACK 'ON-BLUE 'REVERSE 'UNDERLINE))
  ;(display "  ")
  ;(display (colorize-string "infix a string after the last directory slash and before the filename" 'GREEN))
  ;(newline)
  ;(display "  ")
  ;(display (colorize-string "-p, --prefix" 'BLACK 'ON-GREEN 'BOLD 'UNDERLINE))
  ;(display " ")
  ;(display (colorize-string "STRING" 'BLACK 'ON-BLUE 'REVERSE 'UNDERLINE))
  ;(display "  ")
  ;(display (colorize-string "prefix each path name with the provided string" 'GREEN))
  ;(newline)
  ;(display "  ")
  ;(display (colorize-string "-s, --suffix" 'BLACK 'ON-GREEN 'BOLD 'UNDERLINE))
  ;(display " ")
  ;(display (colorize-string "STRING" 'BLACK 'ON-BLUE 'REVERSE 'UNDERLINE))
  ;(display "  ")
  ;(display (colorize-string "suffix each path name with the provided string" 'GREEN))
  ;(newline)
  ;(display "  ")
  ;(display (colorize-string "-t, --trail" 'BLACK 'ON-GREEN 'BOLD 'UNDERLINE))
  ;(display "     ")
  ;(display (colorize-string "append a trailing forward slash character to the end of each path" 'GREEN))
  ;(newline)
  (newlines 2)
  (display "  ")
  (display (colorize-string "<FILES>" 'BLACK 'ON-GREEN 'UNDERLINE))
  (display "              ")
  (display (colorize-string "path names to wordlist files for parsing and expansion" 'YELLOW))
  (newline)
  ;(display "  ")
  ;(display (colorize-string "STRING" 'BLACK 'ON-YELLOW 'REVERSE 'UNDERLINE))
  ;(display "               ")
  ;(display (colorize-string "string to include with created path names by way of prefix, infix and/or suffix" 'BLUE))
  ;(newline)
  (display "  ")
  (display (colorize-string "DEPTH" 'BLACK 'ON-YELLOW 'REVERSE 'UNDERLINE))
  (display "                ")
  (display (colorize-string "maximum number of slashes to allow in computed paths" 'CYAN))
  (newlines 2)
  (exit 0))

(define (display-version)
  (newline)
  (display (colorize-string "pathgro" 'BLACK 'ON-GREEN 'BOLD))
  (display " ")
  (display (colorize-string "v1.0" 'BLACK 'ON-YELLOW 'UNDERLINE))
  (display " ")
  (display (colorize-string "Copyright (C) 2018" 'BLACK 'ON-CYAN))
  (display " ")
  (display (colorize-string "Derek" 'BLACK 'ON-BLUE)) 
  (display " ")
  (display (colorize-string "Callaway" 'BLACK 'ON-BLUE))
  (display " ")
  (display (colorize-string "[" 'YELLOW 'BOLD))
  (display (colorize-string "derek" 'WHITE 'ON-BLUE 'REVERSE 'UNDERLINE))
  (display (colorize-string "." 'BLACK 'ON-MAGENTA 'REVERSE 'UNDERLINE)) 
  (display (colorize-string "callaway" 'WHITE 'ON-BLUE 'REVERSE 'UNDERLINE))
  (display " ")
  (display (colorize-string "(" 'BLACK 'ON-WHITE)) 
  (display (colorize-string "AT" 'WHITE 'ON-BLACK)) 
  (display (colorize-string ")" 'BLACK 'ON-WHITE))
  (display " ")
  (display (colorize-string "ioactive" 'WHITE 'ON-RED 'BOLD 'REVERSE 'UNDERLINE))
  (display " ")
  (display (colorize-string "{" 'BLACK 'ON-WHITE)) 
  (display (colorize-string "D0T" 'WHITE 'ON-BLACK))
  (display (colorize-string "}" 'BLACK 'ON-WHITE))
  (display " ")
  (display (colorize-string "com" 'WHITE 'ON-RED 'BOLD 'REVERSE 'UNDERLINE))
  (display (colorize-string "]" 'YELLOW 'BOLD))
  (newlines 2)
  (display (colorize-string "This program comes with ABSOLUTELY NO WARRANTY. It is free software and you are welcome to redistribute it" 'RED))
  (newline)
  (display (colorize-string "under certain conditions. See the COPYING.txt file in the root directory of the source repository for details." 'RED))
  (newlines 2)
  (display (colorize-string "https://github.com/decal/pathgro" 'BOLD 'REVERSE 'UNDERLINE))
  (newlines 2)
  (exit 0))

(define (main args) 
  (let* 
    ((option-spec '((help       (single-char #\h))
                    (basename   (single-char #\b))
                    (dirname    (single-char #\d))
                    (extname    (single-char #\e))
                    (filename   (single-char #\f))
                    ;(infix      (single-char #\i))
                    (level      (single-char #\l) (value #t))
                    ;(compute    (single-char #\c))
                    ;(suffix     (single-char #\s))
                    ;(prefix     (single-char #\p))
                    ;(trail      (single-char #\t))
                    (extdirname (single-char #\x))
                    (noslash    (single-char #\n))
                    (rmtrail    (single-char #\r))
                    (version    (single-char #\v))))
     (options          (getopt-long args option-spec #:stop-at-first-non-option #t))
     (help-wanted      (option-ref options 'help #f))
     (version-wanted   (option-ref options 'version #f))
     (opt-basename     (option-ref options 'basename #f))
     (opt-dirname      (option-ref options 'dirname #f))
     (opt-extname      (option-ref options 'extname #f))
     (opt-filename     (option-ref options 'filename #f))
     (opt-level        (string->number (option-ref options 'level "0")))
     ;(opt-compute      (not (option-ref options 'compute #f)))
     ;(opt-compute      (option-ref options 'compute #f))
     ;(opt-infix        (option-ref options 'infix ""))
     ;(opt-prefix       (option-ref options 'prefix ""))
     ;(opt-suffix       (option-ref options 'suffix ""))
     (opt-extdirname   (option-ref options 'extdirname #f))
     (opt-noslash      (option-ref options 'noslash #f))
     (opt-rmtrail      (option-ref options 'rmtrail #f)))
    (cond
      (help-wanted
        (display-help))
      (version-wanted
        (display-version))
      (else
        (let ((stripped-args (option-ref options '() '()))
              (pathgro-debug (getenv "PATHGRO_DEBUG")))
          (when (zero? (length stripped-args)) (display-help))
          (read-pathsfiles stripped-args)
          (let ((cfiles (clean (combine-files-helper bases extns)))
                (edirs (clean (combine-files-helper dirns extns))))
                (when opt-noslash (set! prepend-slashes unprepend-slashes))
                (if opt-rmtrail (begin (set! dirns (unappend-slashes dirns))
                                       (set! edirs (unappend-slashes edirs)))
                  (set! unappend-slashes append-slashes))
                (when opt-filename   (output-list (prepend-slashes cfiles)))
                (when opt-basename   (output-list (prepend-slashes bases)))
                (when opt-dirname    (output-list (prepend-slashes dirns)))
                (when opt-extname    (output-list (prepend-slashes extns)))
                (when opt-extdirname (output-list (prepend-slashes edirs)))
                (when (not (zero? opt-level)) 
                  (set! max-depth opt-level) 
                  (let ((aps (path-powerset cfiles dirns)))
                    (output-list (prepend-slashes (flatten aps))))))))))
  (when (zero? pathcnt) (display-help))
  (exit 0))
